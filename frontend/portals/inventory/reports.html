<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Reports - Joitex Fiber</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
</head>

<body data-theme="light">
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar"></aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header"></header>

        <!-- Content -->
        <main class="content">
            <div class="content-header">
                <div>
                    <h1 class="content-title">Inventory Reports</h1>
                    <p class="content-subtitle">Generate and view inventory analytics</p>
                </div>
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Print Reports
                </button>
            </div>

            <!-- Report Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Generate Report</h5>
                </div>
                <div class="card-body">
                    <form id="reportForm" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="stock_summary">Stock Summary</option>
                                <option value="transactions">Transaction History</option>
                                <option value="low_stock">Low Stock Items</option>
                                <option value="top_items">Top Moving Items</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                                <i class="bi bi-file-earmark-text me-2"></i>Generate
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Report Preview -->
            <div id="reportPreview" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="reportTitle">Stock Summary Report</h5>
                        <small class="text-muted" id="reportDate">Generated on: -</small>
                    </div>
                    <div class="card-body">
                        <!-- Summary Stats for Report -->
                        <div class="row g-4 mb-4" id="reportStats">
                            <!-- Injected via JS -->
                        </div>

                        <!-- Report Table -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover mb-0" id="reportTable">
                                <thead class="table-light">
                                    <!-- Dynamic Headers -->
                                </thead>
                                <tbody>
                                    <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placeholder State -->
            <div id="reportPlaceholder" class="text-center py-5 text-muted">
                <i class="bi bi-file-earmark-bar-graph display-1 mb-3"></i>
                <p class="lead">Select parameters above to generate a report.</p>
            </div>

        </main>

        <!-- Footer -->
        <footer class="footer">
            <p class="mb-0">&copy; 2025 Joitex Fiber. All rights reserved. | Version 1.0.0</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/layout.js"></script>
    <script src="../../assets/js/common.js"></script>
    <script>
        auth.protectPage(['inventory']);

        document.addEventListener('DOMContentLoaded', () => {
            Layout.render('inventory');
        });

        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const preview = document.getElementById('reportPreview');
            const placeholder = document.getElementById('reportPlaceholder');
            const reportTitle = document.getElementById('reportTitle');
            const reportDate = document.getElementById('reportDate');
            const table = document.getElementById('reportTable');
            const stats = document.getElementById('reportStats');

            // Show Loading
            placeholder.innerHTML = '<div class="spinner-border text-primary" role="status"></div><p class="mt-2">Generating report...</p>';

            try {
                // Determine API endpoint based on type
                let endpoint = '';
                let title = '';

                switch (reportType) {
                    case 'stock_summary':
                        endpoint = '/inventory/items'; // Fetch all items
                        title = 'Current Stock Summary';
                        break;
                    case 'low_stock':
                        endpoint = '/inventory/items?status=low';
                        title = 'Low Stock Alert Report';
                        break;
                    case 'transactions':
                        endpoint = '/inventory/transactions';
                        title = 'Transaction History Report';
                        break;
                    default:
                        endpoint = '/inventory/items';
                        title = 'Report';
                }

                const res = await fetch('http://127.0.0.1:5000/api' + endpoint, {
                    headers: { 'Authorization': `Bearer ${auth.token}` }
                });

                if (!await auth.checkResponse(res)) return;

                const data = await res.json();

                // Update UI
                placeholder.style.display = 'none';
                preview.style.display = 'block';
                reportTitle.textContent = title;
                reportDate.textContent = 'Generated on: ' + new Date().toLocaleString();

                // Render Table
                renderReportTable(reportType, data, table);

                // Render Simple Stats (Optional improvement: Calculate totals)
                renderReportStats(reportType, data, stats);

            } catch (e) {
                console.error(e);
                placeholder.innerHTML = `<i class="bi bi-exclamation-triangle display-1 text-danger mb-3"></i><p class="lead text-danger">Error generating report.</p>`;
            }
        }

        function renderReportTable(type, data, table) {
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-3">No data found for this report.</td></tr>';
                return;
            }

            if (type === 'transactions') {
                thead.innerHTML = `
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Ref</th>
                        <th>Performed By</th>
                    </tr>
                `;
                tbody.innerHTML = data.map(d => `
                    <tr>
                        <td>${new Date(d.created_at).toLocaleString()}</td>
                        <td><span class="badge bg-${d.transaction_type === 'IN' ? 'success' : (d.transaction_type === 'OUT' ? 'danger' : 'warning')}">${d.transaction_type}</span></td>
                        <td>${d.item_name}</td>
                        <td>${d.quantity}</td>
                        <td>${d.reference || '-'}</td>
                        <td>${d.performed_by || '-'}</td>
                    </tr>
                `).join('');
            } else {
                // Default Item Table (Stock/Low Stock)
                thead.innerHTML = `
                    <tr>
                        <th>SKU</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Stock Level</th>
                        <th>Value (Unit)</th>
                        <th>Status</th>
                    </tr>
                `;
                tbody.innerHTML = data.map(d => `
                    <tr>
                        <td><code>${d.sku}</code></td>
                        <td>${d.name}</td>
                        <td>${d.category}</td>
                        <td class="${d.quantity <= d.min_stock_level ? 'text-danger fw-bold' : ''}">${d.quantity}</td>
                        <td>₹${d.unit_price}</td>
                        <td><span class="badge bg-${d.status === 'in_stock' ? 'success' : (d.status === 'low_stock' ? 'warning' : 'danger')}">${d.status.replace('_', ' ')}</span></td>
                    </tr>
                `).join('');
            }
        }

        function renderReportStats(type, data, container) {
            let html = '';
            if (type === 'transactions') {
                const totalIn = data.filter(d => d.transaction_type === 'IN').reduce((acc, c) => acc + c.quantity, 0);
                const totalOut = data.filter(d => d.transaction_type === 'OUT').reduce((acc, c) => acc + c.quantity, 0);
                html = `
                    <div class="col-md-4"><div class="p-3 border rounded bg-light"><h5>Total Transactions</h5><h3>${data.length}</h3></div></div>
                    <div class="col-md-4"><div class="p-3 border rounded bg-light"><h5>Throughput In</h5><h3 class="text-success">${totalIn}</h3></div></div>
                    <div class="col-md-4"><div class="p-3 border rounded bg-light"><h5>Throughput Out</h5><h3 class="text-danger">${totalOut}</h3></div></div>
                `;
            } else {
                const totalItems = data.length;
                const totalStock = data.reduce((acc, c) => acc + c.quantity, 0);
                const totalValue = data.reduce((acc, c) => acc + (c.quantity * c.unit_price), 0);
                html = `
                    <div class="col-md-4"><div class="p-3 border rounded bg-light"><h5>Items Listed</h5><h3>${totalItems}</h3></div></div>
                    <div class="col-md-4"><div class="p-3 border rounded bg-light"><h5>Total Stock Quantity</h5><h3 class="text-primary">${totalStock}</h3></div></div>
                    <div class="col-md-4"><div class="p-3 border rounded bg-light"><h5>Total Stock Value</h5><h3 class="text-success">₹${totalValue.toLocaleString()}</h3></div></div>
                `;
            }
            container.innerHTML = html;
        }
    </script>
</body>

</html>