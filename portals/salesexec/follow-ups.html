<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow-ups - Joitex Fiber</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
</head>

<body data-theme="light">
    <div class="sidebar-overlay"></div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">
                <i class="bi bi-router-fill" style="color: #6366f1;"></i>
                <span>Joitex Fiber</span>
            </a>
            <button class="sidebar-toggle" id="sidebarToggle"><i class="bi bi-chevron-left"></i></button>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Sales Operations</div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><i
                                class="bi bi-speedometer2"></i><span>Dashboard</span></a></li>
                    <li class="nav-item"><a href="add-lead.html" class="nav-link"><i
                                class="bi bi-plus-circle"></i><span>Add Lead</span></a></li>
                    <li class="nav-item"><a href="my-leads.html" class="nav-link"><i
                                class="bi bi-person-lines-fill"></i><span>My Leads</span></a></li>
                    <li class="nav-item"><a href="follow-ups.html" class="nav-link active"><i
                                class="bi bi-calendar-check"></i><span>Follow-ups</span></a></li>
                    <li class="nav-item"><a href="conversions.html" class="nav-link"><i
                                class="bi bi-trophy"></i><span>Conversions</span></a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="bi bi-list"></i></button>
                <nav aria-label="breadcrumb" class="breadcrumb-container d-none d-md-block">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="dashboard.html">Sales Executive</a></li>
                        <li class="breadcrumb-item active">Follow-ups</li>
                    </ol>
                </nav>
            </div>
            <div class="header-right">
                <button class="header-action" id="themeToggle"><i class="bi bi-moon"></i></button>
                <button class="header-action"><i class="bi bi-bell"></i></button>
                <div class="dropdown">
                    <div class="user-menu" data-bs-toggle="dropdown">
                        <div class="user-avatar" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                            SE</div>
                        <div class="user-info d-none d-md-block">
                            <div class="user-name" id="userName">Sales Executive</div>
                            <div class="user-role">Sales Executive</div>
                        </div>
                        <i class="bi bi-chevron-down ms-2"></i>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" id="logoutBtn"><i
                                    class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </header>

        <main class="content">
            <div class="content-header">
                <h1 class="content-title">Follow-up Schedule</h1>
                <p class="content-subtitle">Track and manage customer follow-ups</p>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card border-danger">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted mb-1">Overdue</p>
                                    <h3 class="mb-0 text-danger">-</h3>
                                </div>
                                <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted mb-1">Today</p>
                                    <h3 class="mb-0 text-warning">-</h3>
                                </div>
                                <i class="bi bi-calendar-day fs-1 text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted mb-1">This Week</p>
                                    <h3 class="mb-0 text-info">-</h3>
                                </div>
                                <i class="bi bi-calendar-week fs-1 text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Overdue Follow-ups</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Last Contact</th>
                                    <th>Due Date</th>
                                    <th>Days Overdue</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center p-4 text-muted">No overdue follow-ups</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-calendar-day me-2"></i>Today's Follow-ups</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Plan Interest</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center p-4 text-muted">No follow-ups scheduled for today
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p class="mb-0">&copy; 2025 Joitex Fiber. All rights reserved. | Version 1.0.0</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/common.js"></script>
    <script>
        auth.protectPage(['salesexec']);
        document.addEventListener('DOMContentLoaded', function () {
            const user = auth.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.querySelector('.user-avatar').textContent = initials;
            }
            loadFollowUps();
        });

        async function loadFollowUps() {
            try {
                const res = await fetch('http://127.0.0.1:5000/api/salesexec/leads', {
                    headers: { 'Authorization': `Bearer ${auth.token}` }
                });
                const leads = await res.json();

                // Demo logic: If no follow_up_date field, we simulate one for "new" leads for demonstration or just show empty if no data.
                // Assuming backend might not return specific follow-up dates yet, we'll just list leads with 'new' or 'feasibility' status as "Today's Follow-ups" for now to populate the list, 
                // or if we strictly want to remove mock data, we just show "No follow-ups" if the data doesn't explicitly support it.
                // However, user asked to "remove mock data". So showing "No data" is better than showing fake data.

                // Let's check if any lead has 'follow_up' status/tag?
                // The dashboard showed "Follow-ups: 7" mockly before.

                // We will render leads that are NOT 'installed' or 'cancelled' in the today list as a fallback, or strictly nothing.
                // Better: Just show "No follow-ups scheduled" if we can't determine it, to be accurate.

                updateStats(leads);
                renderFollowUpTables(leads);

            } catch (e) {
                console.error(e);
                Toast.error('Failed to load follow-ups');
            }
        }

        function updateStats(leads) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const tonight = new Date(now);
            tonight.setHours(23, 59, 59, 999);
            const endOfWeek = new Date(now);
            endOfWeek.setDate(now.getDate() + 7);

            const overdueCount = leads.filter(l => l.follow_up_date && new Date(l.follow_up_date) < now && l.status !== 'installed' && l.status !== 'cancelled').length;
            const todayCount = leads.filter(l => l.follow_up_date && new Date(l.follow_up_date) >= now && new Date(l.follow_up_date) <= tonight).length;
            const weekCount = leads.filter(l => l.follow_up_date && new Date(l.follow_up_date) >= now && new Date(l.follow_up_date) <= endOfWeek).length;

            document.querySelector('.text-danger.mb-0').textContent = overdueCount;
            document.querySelector('.text-warning.mb-0').textContent = todayCount;
            document.querySelector('.text-info.mb-0').textContent = weekCount;
        }

        function renderFollowUpTables(leads) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const tonight = new Date(now);
            tonight.setHours(23, 59, 59, 999);

            const overdueLeads = leads.filter(l => l.follow_up_date && new Date(l.follow_up_date) < now && l.status !== 'installed' && l.status !== 'cancelled');
            const todayLeads = leads.filter(l => l.follow_up_date && new Date(l.follow_up_date) >= now && new Date(l.follow_up_date) <= tonight);

            const tables = document.querySelectorAll('tbody');

            // Overdue Table
            if (tables[0]) {
                if (overdueLeads.length === 0) {
                    tables[0].innerHTML = '<tr><td colspan="6" class="text-center p-4 text-muted">No overdue follow-ups</td></tr>';
                } else {
                    tables[0].innerHTML = overdueLeads.map(l => renderRow(l)).join('');
                }
            }

            // Today's Table
            if (tables[1]) {
                if (todayLeads.length === 0) {
                    tables[1].innerHTML = '<tr><td colspan="6" class="text-center p-4 text-muted">No follow-ups scheduled for today</td></tr>';
                } else {
                    tables[1].innerHTML = todayLeads.map(l => renderRow(l)).join('');
                }
            }
        }

        function renderRow(l) {
            const time = l.follow_up_date ? new Date(l.follow_up_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Anytime';
            return `
                <tr>
                    <td>${time}</td>
                    <td><strong>${l.name}</strong></td>
                    <td>${l.phone}</td>
                    <td><span class="badge bg-info">${l.plan_interest || 'Fiber Basic'}</span></td>
                    <td>${l.notes || '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="callNow('${l.lead_number}')"><i class="bi bi-telephone"></i></button>
                            <button class="btn btn-outline-primary" onclick="markComplete('${l.lead_number}')"><i class="bi bi-check-lg"></i></button>
                            <button class="btn btn-outline-secondary" onclick="reschedule('${l.lead_number}')"><i class="bi bi-clock"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function callNow(leadId) {
            Toast.info(`Initiating call for ${leadId}...`, 2000);
        }

        function markComplete(leadId) {
            Toast.success(`Follow-up completed for ${leadId}!`, 2000);
        }

        function reschedule(leadId) {
            Toast.info(`Rescheduling follow-up for ${leadId}...`, 2000);
        }
    </script>
</body>

</html>