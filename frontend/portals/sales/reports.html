<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reports - Joitex Fiber</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
</head>

<body data-theme="light">
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar"></aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header"></header>

        <!-- Content -->
        <main class="content">
            <div class="content-header">
                <div>
                    <h1 class="content-title">Sales Reports</h1>
                    <p class="content-subtitle">Analyze sales performance and trends</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer me-2"></i>Print
                    </button>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="bi bi-file-earmark-arrow-down me-2"></i>Download PDF
                    </button>
                </div>
            </div>

            <!-- Report Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Report Configuration</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="performance">Team Performance</option>
                                <option value="conversion">Conversion Rates</option>
                                <option value="pipeline">Sales Pipeline</option>
                                <option value="revenue">Revenue Forecast</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange">
                                <option value="this_month">This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-secondary w-100" onclick="loadReportData()">
                                <i class="bi bi-search me-2"></i>View Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Content -->
            <div id="reportContent" class="card">
                <div class="card-body text-center p-5">
                    <img src="https://cdni.iconscout.com/illustration/premium/thumb/sales-report-2839462-2371420.png"
                        alt="Analytics" style="max-height: 200px; opacity: 0.8;" class="mb-3">
                    <h4>Select a report type to view analysis</h4>
                    <p class="text-muted">Choose parameters above to generate detailed insights.</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p class="mb-0">&copy; 2025 Joitex Fiber. All rights reserved. | Version 1.0.0</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/layout.js"></script>
    <script src="../../assets/js/common.js"></script>
    <script>
        // Protect page
        auth.protectPage(['sales']);

        document.addEventListener('DOMContentLoaded', () => {
            Layout.render('sales');
        });

        function generateReport() {
            Toast.info('Generating PDF report...');
            // Mock delay
            setTimeout(() => {
                Toast.success('Report downloaded successfully');
            }, 2000);
        }

        async function loadReportData() {
            const reportType = document.getElementById('reportType').value;
            const container = document.getElementById('reportContent');

            // Show loading
            container.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Analyzing data...</p>
                </div>
            `;

            // Mock fetching data (since we don't have dedicated report endpoints yet)
            // In a real app, this would fetch from /api/sales/reports/...

            // Re-fetch stats to simulate dynamic content
            try {
                // Use hardcoded URL to match project pattern
                const res = await fetch('http://127.0.0.1:5000/api/sales/stats', {
                    headers: { 'Authorization': `Bearer ${auth.token}` }
                });

                if (!await auth.checkResponse(res)) return;

                const data = await res.json();

                // Render dummy report
                setTimeout(() => {
                    renderMockReport(container, reportType, data);
                }, 800);

            } catch (e) {
                console.error(e);
                container.innerHTML = `
                    <div class="text-center p-5 text-danger">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                        <p>Failed to load report data</p>
                    </div>
                `;
            }
        }

        function renderMockReport(container, type, data) {
            let title = '';
            let content = '';

            switch (type) {
                case 'pipeline':
                    title = 'Sales Pipeline Analysis';
                    content = `
                        <div class="row">
                            <div class="col-md-6 offset-md-3">
                                <canvas id="reportChart"></canvas>
                            </div>
                        </div>
                        <div class="mt-4">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Stage</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.pipeline_chart.labels.map((l, i) => `
                                        <tr>
                                            <td>${l}</td>
                                            <td>${data.pipeline_chart.data[i]}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;
                default:
                    title = 'General Performance Report';
                    content = `
                        <div class="row">
                            <div class="col-md-3">
                                <div class="p-3 border rounded text-center">
                                    <div class="text-muted small">Leads Closed</div>
                                    <div class="h3 text-success">${data.kpi.leads_closed}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 border rounded text-center">
                                    <div class="text-muted small">New Inquiries</div>
                                    <div class="h3 text-primary">${data.kpi.new_inquiries}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 border rounded text-center">
                                    <div class="text-muted small">Pending Feasibility</div>
                                    <div class="h3 text-warning">${data.kpi.feasibility_pending}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="p-3 border rounded text-center">
                                    <div class="text-muted small">Installation in Progress</div>
                                    <div class="h3 text-info">${data.kpi.installations_progress}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center text-muted">
                            <p>Detailed analysis chart would appear here.</p>
                        </div>
                    `;
            }

            container.innerHTML = `
                <div class="card-header bg-white">
                    <h5 class="mb-0">${title}</h5>
                    <small class="text-muted">Generated on ${new Date().toLocaleString()}</small>
                </div>
                <div class="card-body">
                    ${content}
                </div>
            `;

            if (type === 'pipeline') {
                const ctx = document.getElementById('reportChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.pipeline_chart.labels,
                        datasets: [{
                            data: data.pipeline_chart.data,
                            backgroundColor: [
                                '#3b82f6', '#f59e0b', '#10b981', '#6366f1', '#ef4444'
                            ]
                        }]
                    },
                    options: { responsive: true }
                });
            }
        }
    </script>
</body>

</html>